<!doctype html>

<html lang="en">
  <head>
    <meta charset="utf-8">

    <title>Something wrong</title>

    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <style>
#apps {
  padding: 3em;
  max-width: 500px;
  margin: 0 auto;
  font-family: 'arial', sans-serif;
}

.app {
  padding: .65em;
  border-radius: .25em;
  display: flex;
  text-decoration: none;
  flex-direction: row-reverse;
}

.app.ok {
  border: 1px solid #5cb85c;
  color: #5cb85c;
  font-weight: normal;
}

.app.not_ok {
  border: 1px solid #e60000;
  background-color: #e60000;
  color: white;
  font-weight: bold;
}

.app h2 {
  width: 85%;
  font-size: 1em;
  margin: 0;
  font-weight: inherit;
}

.app .health {
  width: 15%;
  text-align: center;
  font-weight: bold;
}
    </style>
  </head>

  <body>
    <main>
    <div id="apps"></div>
    <div class="help"></div>
    </main>
    <template id="app-template" data-app-id="">
      <a class="app" href="#">
        <div class="health"></div>
        <h2></h2>
        <div class="report"></div>
        </div>
    </template>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
    <script>

function params() {
  var queryDict = {}
  location.search.substr(1).split("&").forEach(function(item) {queryDict[item.split("=")[0]] = item.split("=")[1]});
  return queryDict;
}

function drawApps() {
  $.ajax({
    url: '/apps',
    data: { 
      api_key: params()['api_key']
    }
  })
  .done(function(res) {
    $.each(res.data, function() {
      drawApp(this);
    })
  })
}

function hookApp(app, element) {
  element.click(function() {
    if(app.attributes.ok) {
      $.ajax({
        url: app.links.problem,
        method: 'POST',
        data: { 
          api_key: params()['api_key'],
          app: { 
            data: 'manual'
          }
        }
      })
      .done(function(res) {
        window.location.reload();
      });
    } else {
      $.ajax({
        url: app.links.solution,
        method: 'POST',
        data: { 
          api_key: params()['api_key']
        }
      })
      .done(function(res) {
        window.location.reload();
      });
    }
  });
}

function drawApp(app) {
  var t = document.querySelector('template#app-template').content;
  var clone = document.importNode(t, true);
  var app_elem = $(clone).find('.app');
  app_elem.addClass(app.attributes.ok ? 'ok' : 'not_ok');
  app_elem.find('h2').html(app.attributes.name);
  app_elem.find('.health').html(app.attributes.ok ? 'âœ“' : '!');
  if(app.attributes.ok) {
    app_elem.find('.report').html(app);
  }
  app_elem.data('app-id', app.id);
  hookApp(app, app_elem);
  document.getElementById("apps").appendChild(clone);
}

$(document).ready(function() {
  drawApps();
});
    </script>
  </body>
</html>
